<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Microphone Test</title>
</head>
<body>
  <h1>ğŸ¤ Microphone Test</h1>
  <video id="video" width="320" height="240" autoplay muted></video>
  <p id="status">ìƒíƒœ: ëŒ€ê¸° ì¤‘</p>

  <script>
    const videoEl = document.getElementById("video");
    const statusEl = document.getElementById("status");

    async function testMic() {
      statusEl.textContent = "ìƒíƒœ: getUserMedia í˜¸ì¶œâ€¦";
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
          video: true,
        });
        statusEl.textContent = "ìƒíƒœ: getUserMedia ì„±ê³µ! ğŸ‰";
        videoEl.srcObject = stream;

        // AudioContext + ê°„ë‹¨íˆ level ì²´í¬
        const audioCtx = new AudioContext();
        const source = audioCtx.createMediaStreamSource(stream);
        const analyser = audioCtx.createAnalyser();
        source.connect(analyser);
        analyser.fftSize = 256;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);

        function draw() {
          analyser.getByteFrequencyData(dataArray);
          const sum = dataArray.reduce((a, b) => a + b, 0);
          const avg = sum / dataArray.length;
          // 0~255 ì‚¬ì´, ìˆ˜ì¹˜ê°€ ì˜¬ë¼ê°„ë‹¤ëŠ” ê±´ ìŒì„± ì‹ í˜¸ê°€ ë“¤ì–´ì˜¨ë‹¤ëŠ” ëœ»
          console.log("â–¶ï¸ [DEBUG] ë§ˆì´í¬ ë ˆë²¨ í‰ê· ê°’:", avg);
          requestAnimationFrame(draw);
        }
        draw();
      } catch (err) {
        statusEl.textContent = "ìƒíƒœ: getUserMedia ì‹¤íŒ¨ ğŸ˜¢";
        console.error("â–¶ï¸ [ERROR] testMic getUserMedia ì‹¤íŒ¨:", err);
      }
    }

    testMic();
  </script>
</body>
</html>
